{"version":3,"sources":["../src/table_ctrl.js"],"names":["_","$","MetricsPanelCtrl","transformDataToTable","tablePanelEditor","columnOptionsTab","TableRenderer","form","utils","materialOption","panelDefaults","targets","transform","pageSize","showHeader","styles","type","pattern","alias","dateFormat","headerColor","unit","decimals","colors","colorMode","thresholds","columns","scroll","fontSize","sort","col","desc","TableCtrl","$scope","$injector","templateSrv","annotationsSrv","$sanitize","variableSrv","pageIndex","panel","fields","defaults","events","on","onDataReceived","bind","onDataError","onInitEditMode","onInitPanelActions","document","off","e","rowData","map","index","td","childNodes","length","nodeValue","text","nameIndex","ctrl","colDimensions","indexOf","alert","currentMaterial","findMaterialByName","materials","showOptionModal","addEditorTab","actions","push","click","datasource","setTimeQueryStart","getAnnotations","dashboard","range","then","data","annotations","err","dataRaw","render","dataList","undefined","sortList","getRestructuredData","rows","materialDimensions","materialNames","material","name","wholeData","copy","checkFilterKeyWord","key","filterKeyword","findIndexByKeyOnDimension","descIndex","filteredRows","filter","row","toLowerCase","includes","showMaterialForm","a","b","localeCompare","table","renderer","isTimezoneUtc","colIndex","scope","$new","tableData","render_values","publishAppEvent","templateHtml","modalClass","elem","attrs","pageCount","getTableHeight","panelHeight","height","appendTableRows","tbodyElem","setTable","empty","html","switchPage","el","currentTarget","parseInt","renderPanel","appendPaginationControls","footerElem","Math","ceil","startPage","max","endPage","min","paginationList","i","activeClass","pageLinkElem","append","panelElem","parents","rootElem","find","css","addClass","split","x","hidden","tooltip","selector","addFilterClicked","filterData","options","column","value","operator","setAdhocFilter","unbindDestroy","$on","renderData","renderingCompleted","templateUrl"],"mappings":"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","file":"table_ctrl.js","sourcesContent":["import _ from 'lodash';\r\nimport $ from 'jquery';\r\nimport {MetricsPanelCtrl} from 'app/plugins/sdk';\r\nimport {transformDataToTable} from './transformers';\r\nimport {tablePanelEditor} from './editor';\r\nimport {columnOptionsTab} from './column_options';\r\nimport {TableRenderer} from './renderer';\r\n\r\nimport * as form from './addMaterial'\r\nimport * as utils from './utils'\r\nimport * as materialOption from './materialOptions'\r\n\r\nimport './css/style.css!';\r\nimport './css/instant-serach.css!';\r\n\r\nconst panelDefaults = {\r\n  targets: [{}],\r\n  transform: 'timeseries_to_columns',\r\n  pageSize: null,\r\n  showHeader: true,\r\n  styles: [\r\n    {\r\n      type: 'date',\r\n      pattern: 'Time',\r\n      alias: 'Time',\r\n      dateFormat: 'YYYY-MM-DD HH:mm:ss',\r\n      headerColor: \"rgba(51, 181, 229, 1)\"\r\n    },\r\n    {\r\n      unit: 'short',\r\n      type: 'number',\r\n      alias: '',\r\n      decimals: 2,\r\n      headerColor: \"rgba(51, 181, 229, 1)\",\r\n      colors: [\"rgba(245, 54, 54, 0.9)\", \"rgba(237, 129, 40, 0.89)\", \"rgba(50, 172, 45, 0.97)\"],\r\n      colorMode: null,\r\n      pattern: '/.*/',\r\n      thresholds: [],\r\n    }\r\n  ],\r\n  columns: [],\r\n  scroll: true,\r\n  fontSize: '100%',\r\n  sort: { col: 0, desc: true },\r\n};\r\n\r\nexport class TableCtrl extends MetricsPanelCtrl {\r\n\r\n  constructor($scope, $injector, templateSrv, annotationsSrv, $sanitize, variableSrv) {\r\n    super($scope, $injector);\r\n\r\n    this.pageIndex = 0;\r\n\r\n    if (this.panel.styles === void 0) {\r\n      this.panel.styles = this.panel.columns;\r\n      this.panel.columns = this.panel.fields;\r\n      delete this.panel.columns;\r\n      delete this.panel.fields;\r\n    }\r\n\r\n    _.defaults(this.panel, panelDefaults);\r\n\r\n    this.events.on('data-received', this.onDataReceived.bind(this));\r\n    this.events.on('data-error', this.onDataError.bind(this));\r\n    this.events.on('data-snapshot-load', this.onDataReceived.bind(this));\r\n    this.events.on('init-edit-mode', this.onInitEditMode.bind(this));\r\n    this.events.on('init-panel-actions', this.onInitPanelActions.bind(this));\r\n\r\n    $(document).off('click', 'tr.tr-affect#master-data-material-tr')\r\n    $(document).on('click', 'tr.tr-affect#master-data-material-tr', function (e) {\r\n      const rowData = $('td', this).map((index, td)=>{\r\n        if (td.childNodes.length === 2) {\r\n          return td.childNodes[1].nodeValue\r\n        }else if (td.childNodes.length === 1) {\r\n          return $(td).text()\r\n        }else {\r\n          return ''\r\n        }\r\n      })\r\n\r\n      // in database id is the increment key, but for the user, id is the name\r\n      // so for inside code, we call it the name, but for outside where the user can reach we call it id to reduce user's confusion\r\n      const nameIndex = $scope.ctrl.colDimensions.indexOf(\"name\")\r\n      if (!~nameIndex) {\r\n        utils.alert('error', 'Error', 'Get not get this material from the database, please contact the dev team')\r\n        return\r\n      }else {\r\n        $scope.ctrl.currentMaterial = utils.findMaterialByName($scope.ctrl.materials, rowData[nameIndex])[0]\r\n        materialOption.showOptionModal($scope.ctrl)\r\n      }\r\n    })\r\n  }\r\n\r\n  onInitEditMode() {\r\n    this.addEditorTab('Options', tablePanelEditor, 2);\r\n    this.addEditorTab('Column Styles', columnOptionsTab, 3);\r\n  }\r\n\r\n  onInitPanelActions(actions) {\r\n    actions.push({ text: 'Export CSV', click: 'ctrl.exportCsv()' });\r\n  }\r\n\r\n  issueQueries(datasource) {\r\n    this.pageIndex = 0;\r\n\r\n    if (this.panel.transform === 'annotations') {\r\n      this.setTimeQueryStart();\r\n      return this.annotationsSrv\r\n        .getAnnotations({\r\n          dashboard: this.dashboard,\r\n          panel: this.panel,\r\n          range: this.range,\r\n        })\r\n        .then(annotations => {\r\n          return { data: annotations };\r\n        });\r\n    }\r\n\r\n    return super.issueQueries(datasource);\r\n  }\r\n\r\n  onDataError(err) {\r\n    this.dataRaw = [];\r\n    this.render();\r\n  }\r\n\r\n  onDataReceived(dataList) {\r\n\r\n    if (dataList.length === 0 || dataList === null || dataList === undefined) {\r\n      return\r\n    }\r\n\r\n    if (dataList[0].type !== 'table') {\r\n      utils.alert('error', 'Error', 'To show the product list, please format data as a TABLE in the Metrics Setting')\r\n      return\r\n    }\r\n\r\n    dataList = this.sortList(dataList)\r\n    this.materials = utils.getRestructuredData(dataList[0].columns, dataList[0].rows)\r\n    this.materialDimensions = dataList[0].columns.map(col => col.text)\r\n    this.materialNames = this.materials.map(material => material.name)\r\n\r\n    this.dataRaw = dataList;\r\n    this.wholeData = utils.copy(this.dataRaw)\r\n\r\n    this.pageIndex = 0;\r\n    // automatically correct transform mode based on data\r\n    if (this.dataRaw && this.dataRaw.length) {\r\n      if (this.dataRaw[0].type === 'table') {\r\n        this.panel.transform = 'table';\r\n      } else {\r\n        if (this.dataRaw[0].type === 'docs') {\r\n          this.panel.transform = 'json';\r\n        } else {\r\n          if (this.panel.transform === 'table' || this.panel.transform === 'json') {\r\n            this.panel.transform = 'timeseries_to_rows';\r\n          }\r\n        }\r\n      }\r\n    }\r\n\r\n    // check filter keywords\r\n    this.checkFilterKeyWord()\r\n    // this.render();\r\n  }\r\n\r\n  checkFilterKeyWord(){\r\n    const key = this.filterKeyword\r\n    this.dataRaw = utils.copy(this.wholeData)\r\n    if (key) {\r\n      // search\r\n      const nameIndex = utils.findIndexByKeyOnDimension(this.materialDimensions, 'name')\r\n      const descIndex = utils.findIndexByKeyOnDimension(this.materialDimensions, 'description')\r\n      const filteredRows = this.dataRaw[0].rows.filter(row => {\r\n        if (row[nameIndex].toLowerCase().includes(key.toLowerCase()) || row[descIndex].toLowerCase().includes(key.toLowerCase())) {\r\n          return row\r\n        }\r\n      })\r\n      this.dataRaw[0].rows = filteredRows\r\n    }\r\n    this.render()\r\n  }\r\n\r\n  onAddButtonClick(){\r\n    form.showMaterialForm(this)\r\n  }\r\n\r\n  sortList(dataList){\r\n    if (dataList[0].rows.length === 0) {\r\n      return dataList\r\n    }\r\n\r\n    dataList[0].rows = dataList[0].rows.sort((a,b) => (a[1] + '').localeCompare(b[1] + ''))\r\n    return dataList;\r\n  }\r\n\r\n  render() {\r\n    this.table = transformDataToTable(this.dataRaw, this.panel);\r\n    this.table.sort(this.panel.sort);\r\n    this.renderer = new TableRenderer(\r\n      this.panel,\r\n      this.table,\r\n      this.dashboard.isTimezoneUtc(),\r\n      this.$sanitize,\r\n      this.templateSrv,\r\n      this.col\r\n    );\r\n\r\n    return super.render(this.table);\r\n  }\r\n\r\n  toggleColumnSort(col, colIndex) {\r\n    // remove sort flag from current column\r\n    if (this.table.columns[this.panel.sort.col]) {\r\n      this.table.columns[this.panel.sort.col].sort = false;\r\n    }\r\n\r\n    if (this.panel.sort.col === colIndex) {\r\n      if (this.panel.sort.desc) {\r\n        this.panel.sort.desc = false;\r\n      } else {\r\n        this.panel.sort.col = null;\r\n      }\r\n    } else {\r\n      this.panel.sort.col = colIndex;\r\n      this.panel.sort.desc = true;\r\n    }\r\n    this.render();\r\n  }\r\n\r\n  exportCsv() {\r\n    const scope = this.$scope.$new(true);\r\n    scope.tableData = this.renderer.render_values();\r\n    scope.panel = 'table';\r\n    this.publishAppEvent('show-modal', {\r\n      templateHtml: '<export-data-modal panel=\"panel\" data=\"tableData\"></export-data-modal>',\r\n      scope,\r\n      modalClass: 'modal--narrow',\r\n    });\r\n  }\r\n\r\n  link(scope, elem, attrs, ctrl) {\r\n    let data;\r\n    const panel = ctrl.panel;\r\n    let pageCount = 0;\r\n\r\n    function getTableHeight() {\r\n      let panelHeight = ctrl.height;\r\n\r\n      if (pageCount > 1) {\r\n        panelHeight -= 26;\r\n      }\r\n\r\n      return panelHeight - 31 + 'px';\r\n    }\r\n\r\n    function appendTableRows(tbodyElem) {\r\n      ctrl.renderer.setTable(data);\r\n      tbodyElem.empty();\r\n      tbodyElem.html(ctrl.renderer.render(ctrl.pageIndex));\r\n    }\r\n\r\n    function switchPage(e) {\r\n      const el = $(e.currentTarget);\r\n      ctrl.pageIndex = parseInt(el.text(), 10) - 1;\r\n      renderPanel();\r\n    }\r\n\r\n    function appendPaginationControls(footerElem) {\r\n      footerElem.empty();\r\n\r\n      const pageSize = panel.pageSize || 100;\r\n      pageCount = Math.ceil(data.rows.length / pageSize);\r\n      if (pageCount === 1) {\r\n        return;\r\n      }\r\n\r\n      const startPage = Math.max(ctrl.pageIndex - 3, 0);\r\n      const endPage = Math.min(pageCount, startPage + 9);\r\n\r\n      const paginationList = $('<ul></ul>');\r\n\r\n      for (let i = startPage; i < endPage; i++) {\r\n        const activeClass = i === ctrl.pageIndex ? 'active' : '';\r\n        const pageLinkElem = $(\r\n          '<li><a class=\"table-panel-page-link pointer ' + activeClass + '\">' + (i + 1) + '</a></li>'\r\n        );\r\n        paginationList.append(pageLinkElem);\r\n      }\r\n\r\n      footerElem.append(paginationList);\r\n    }\r\n\r\n    function renderPanel() {\r\n      const panelElem = elem.parents('.panel-content');\r\n      const rootElem = elem.find('.table-panel-scroll');\r\n      const tbodyElem = elem.find('tbody');\r\n      const footerElem = elem.find('.table-panel-footer');\r\n\r\n      elem.css({ 'font-size': panel.fontSize });\r\n      panelElem.addClass('table-panel-content');\r\n\r\n      appendTableRows(tbodyElem);\r\n      appendPaginationControls(footerElem);\r\n      const height = parseInt(getTableHeight().split('px')[0]) - 38 + 'px'\r\n      rootElem.css({ 'max-height': panel.scroll ? height : '' });\r\n\r\n      // get current table column dimensions \r\n      if (ctrl.table.columns) {\r\n        ctrl.colDimensions = ctrl.table.columns.filter(x => !x.hidden).map(x => x.text)\r\n      }\r\n    }\r\n\r\n    // hook up link tooltips\r\n    elem.tooltip({\r\n      selector: '[data-link-tooltip]',\r\n    });\r\n\r\n    function addFilterClicked(e) {\r\n      const filterData = $(e.currentTarget).data();\r\n      const options = {\r\n        datasource: panel.datasource,\r\n        key: data.columns[filterData.column].text,\r\n        value: data.rows[filterData.row][filterData.column],\r\n        operator: filterData.operator,\r\n      };\r\n\r\n      ctrl.variableSrv.setAdhocFilter(options);\r\n    }\r\n\r\n    elem.on('click', '.table-panel-page-link', switchPage);\r\n    elem.on('click', '.table-panel-filter-link', addFilterClicked);\r\n\r\n    const unbindDestroy = scope.$on('$destroy', () => {\r\n      elem.off('click', '.table-panel-page-link');\r\n      elem.off('click', '.table-panel-filter-link');\r\n      unbindDestroy();\r\n    });\r\n\r\n    ctrl.events.on('render', renderData => {\r\n      data = renderData || data;\r\n      if (data) {\r\n        renderPanel();\r\n      }\r\n      ctrl.renderingCompleted();\r\n    });\r\n  }\r\n\r\n}\r\n\r\nTableCtrl.templateUrl = './partials/module.html';\r\n"]}